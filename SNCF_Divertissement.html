<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <style>
    body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0;font-family : 'Arial'; font-size: 15}
    rect { opacity:1;}
  </style>
</head>

<body>
<div>
  <script>
    // Feel free to change or delete any of the code you see in this editor!
    var margin = {top : 20,left: 0, right: 20, bottom: 20}
    
    var svg = d3.select("body").append("svg")
      .attr("width", 960)
      .attr("height", 500);

    // gare 1 selectionnée virtuellement 
    var gare1 = 713040; //384008 //713040//  
    // gare 2 selectionnée virtuellement
    var gare2 = 384008; //172007
    
    var w_rect = 18;
    var h_rect = 36;
    var x_divertissements1= 220;
    var x_divertissements2= x_divertissements1+w_rect;
    var y_divertissements = 95;
    var y_acces = 160;
    
    var couleur1 = 'green';
    var couleur2 =	'yellow';
    var couleur3 = 'lightgrey';
    
 		// définition des dimensions globalisées des carrés
    
		var histo_acces = svg.append("g");
    
    var div = d3.select("body").append("div")	
    .attr("class", "tooltip")
    .attr("width","50px")
    //.style("position","absolute")
    .style("display","inlineblock")
    .style("background-color","white")
    .style("border","1px solid grey")
    .style("border-radius","10px")
    .style("opacity", 0);
 	

// début csv
d3.csv("all-joined-datasets.csv",function(data){

  var divertissements1 = [{uic: gare1}] //json avec les divertissements en gare1
  var divertissements2 = [{uic: gare2}] //json avec les divertissements en gare2
  
  var acces1 = [{uic: gare1}] //json avec les moyens d'acces en gare1
  var acces2 = [{uic: gare2}] //json avec les moyens d'acces en gare2
  
  var motif1 = [{uic: gare1}] //json avec les motif d'arrivé en gare1
  var motif2 = [{uic: gare2}] //json avec les motif d'arrivé en gare2
  
  //parcour des données
  data.forEach(function(d){
    // text
    d.variation = (+d.voyageurs_2016-+d.voyageurs_2015)/(d.voyageurs_2015)

	if(d.Code_UIC == gare1){
		divertissements1.push({wifi: d.Wifi,
													 baby_foot: d.Baby_Foot,
													 powerstation: d.Power_Station,
													 piano: d.Piano,
													 histoires: d.Distr_Histoires_Courtes})
    
    acces1.push({voiture: +d.deux_roues_motorisees + +d.Autres_voitures_location_autopartage + +d.Voiture_Conducteur + +d.Voiture_passager,
                 taxis: +d.Taxis,
    						 bus: +d.Bus_Car_Navette,
                 metro: +d.Metro_RER,
                 tram: +d.Tramway,
    						 marche: +d.Marche,
    						 velo: +d.Velo})
    
    motif1.push({divers: +d.Demarches_administratives_medicales_ou_achat,
                 commute: +d.Deplacement_domicile_travail_habituel,
                 etudes: +d.Deplacement_domicile_etude_y_compris_stage,
    						 occasionnel: +d.Deplacement_professionnel_occasionnel,
   							 loisirs: +d.Loisirs_vacances_visite_d_un_proche_ou_ami})
  }  
	if(d.Code_UIC == gare2){
		divertissements2.push({wifi: d.Wifi,
													 baby_foot: d.Baby_Foot,
													 powerstation: d.Power_Station,
													 piano: d.Piano,
													 histoires: d.Distr_Histoires_Courtes})
    
    acces2.push({voiture: +d.deux_roues_motorisees + +d.Autres_voitures_location_autopartage + +d.Voiture_Conducteur + +d.Voiture_passager,
                 taxis: +d.Taxis,
    						 bus: +d.Bus_Car_Navette,
                 metro: +d.Metro_RER,
                 tram: +d.Tramway,
    						 marche: +d.Marche,
    						 velo: +d.Velo})
    
    motif2.push({divers: +d.Demarches_administratives_medicales_ou_achat,
                 commute: +d.Deplacement_domicile_travail_habituel,
                 etudes: +d.Deplacement_domicile_etude_y_compris_stage,
    						 occasionnel: +d.Deplacement_professionnel_occasionnel,
   							 loisirs: +d.Loisirs_vacances_visite_d_un_proche_ou_ami})
  }
	})
  if (gare1 == null && gare2 != null){
    divertissements1 = divertissements2
    acces1 = acces2
    motif1 = motif2;
  }
  else if(gare1 != null && gare2 == null){
    divertissements2 = divertissements1
    acces2 = acces1
    motif2 = motif1;
  }

  refreshText(data,gare1,gare2)
  refreshDiv(divertissements1,divertissements2)
  refreshAcces(acces1,acces2)
  d3.selectAll("rect")
          .attr("width",w_rect)
          .attr("height",h_rect)
  // utilisation des dimensions globalisées #modif


  refreshMotif(motif1,motif2)
  if(gare1==null){d3.selectAll("rect").style("fill",couleur2);}
  else if(gare2==null){d3.selectAll("rect").style("fill",couleur1);}


  ;

})
    // Définition des fonctions

    function refreshText(data,gare1,gare2){

        // emplacement du text 'nom des gares'
        svg.append("text")
            .attr("id","nom")
            .text("Nom des gares")
            .attr("y", 0 + margin.top)
            .attr("x", 0 + margin.left)
            .attr("text-anchor","start")

        // emplacement du nom de la gare 1
        svg.append("text")
            .attr("id","nom1")
            .text("")
            .attr("y", 0 + margin.top)
            .attr("x", function(){return d3.select("#nom").attr("x")+275})
            .attr("text-anchor","end")

        // emplacement du nom de la gare 2
        svg.append("text")
            .attr("id","nom2")
            .text("")
            .attr("y", 0 + margin.top)
            .attr("x", function(){return d3.select("#nom").attr("x")+350})
            .attr("text-anchor","start")


      // emplacement du text 'nombre de voyageurs'
      svg.append("text")
              .attr("id","Nombredevoyageurs")
              .text("Nombre de voyageurs")
              .attr("y", 30 + margin.top)
              .attr("x", 0 + margin.left)
              .attr("text-anchor","start")

      // emplacement de la valeur correspondante pour la gare 1
      svg.append("text")
              .attr("id","valeur_voyageurs")
              .text("")
              .attr("y", 30 + margin.top)
              .attr("x",function(){return d3.select("#Nombredevoyageurs").attr("x")+275})
              .attr("text-anchor","end")

      // emplacement de la valeur correspondante pour la gare 2
      svg.append("text")
              .attr("id","valeur_voyageurs2")
              .text("")
              .attr("y", 30 + margin.top)
              .attr("x", function(){return d3.select("#Nombredevoyageurs").attr("x")+350})
              .attr("text-anchor","start")

      // emplacement du text 'variation par rapport à 2015'
      svg.append("text")
              .attr("id","Variation")
              .text("Variation par rapport à 2015")
              .attr("y", 60 + margin.top)
              .attr("x", 0 + margin.left)
              .attr("text-anchor","start")

      // emplacement de la valeur correspondante pour la gare 1
      svg.append("text")
              .attr("id","valeur_variation")
              .text("")
              .attr("y", 78 + margin.left)
              .attr("x", function(){return d3.select("#Variation").attr("x")+275})
              .style("text-anchor","end")

      // emplacement de la valeur correspondante pour la gare 2
      svg.append("text")
              .attr("id","valeur_variation2")
              .text("")
              .attr("y", 78 + margin.left)
              .attr("x", function(){return d3.select("#Variation").attr("x")+350})
              .style("text-anchor","start")

      // emplacement du text 'Divertissement'
      svg.append("text")
              .attr("id","Wifi")
              .text("Divertissements")
              .attr("y", 100 + margin.top)
              .attr("x", 0 + margin.left)
              .attr("text-anchor","start")

      // emplacement du text "Moyens d'acces"
      svg.append("text")
              .attr("id","Moyenacces")
              .text("Moyens d'accès")
              .attr("y", 145 + margin.top)
              .attr("x", 0 + margin.left)
              .attr("text-anchor","start")

      // emplacement du text "Motif du déplacement"
      svg.append("text")
              .attr("id","Motifsdeplacements")
              .text("Motif du déplacement")
              .attr("y", 190 + margin.top)
              .attr("x", 150 )
              .attr("text-anchor","start")

      // emplacement du text 'nombre de voyageurs'
      svg.append("text")
              .attr("id","Nombredevoyageurs")
              .text("Nombre de voyageurs")
              .attr("y", 30 + margin.top)
              .attr("x", 0 + margin.left)
              .attr("text-anchor","start")

      // emplacement de la valeur correspondante pour la gare 1
      svg.append("text")
              .attr("id","valeur_voyageurs")
              .text("")
              .attr("y", 30 + margin.top)
              .attr("x",function(){return d3.select("#Nombredevoyageurs").attr("x")+275})
              .attr("text-anchor","end")

      // emplacement de la valeur correspondante pour la gare 2
      svg.append("text")
              .attr("id","valeur_voyageurs2")
              .text("")
              .attr("y", 30 + margin.top)
              .attr("x", function(){return d3.select("#Nombredevoyageurs").attr("x")+350})
              .attr("text-anchor","start")

      // emplacement du text 'variation par rapport à 2015'
      svg.append("text")
              .attr("id","Variation")
              .text("Variation par rapport à 2015")
              .attr("y", 60 + margin.top)
              .attr("x", 0 + margin.left)
              .attr("text-anchor","start")

      // emplacement de la valeur correspondante pour la gare 1
      svg.append("text")
              .attr("id","valeur_variation")
              .text("")
              .attr("y", 78 + margin.left)
              .attr("x", function(){return d3.select("#Variation").attr("x")+275})
              .style("text-anchor","end")

      // emplacement de la valeur correspondante pour la gare 2
      svg.append("text")
              .attr("id","valeur_variation2")
              .text("")
              .attr("y", 78 + margin.left)
              .attr("x", function(){return d3.select("#Variation").attr("x")+350})
              .style("text-anchor","start")

      // emplacement du text 'Divertissement'
      svg.append("text")
              .attr("id","Wifi")
              .text("Divertissements")
              .attr("y", 100 + margin.top)
              .attr("x", 0 + margin.left)
              .attr("text-anchor","start")

      // emplacement du text "Moyens d'acces"
      svg.append("text")
              .attr("id","Moyenacces")
              .text("Moyens d'accès")
              .attr("y", 145 + margin.top)
              .attr("x", 0 + margin.left)
              .attr("text-anchor","start")

      // emplacement du text "Motif du déplacement"
      svg.append("text")
              .attr("id","Motifsdeplacements")
              .text("Motif du déplacement")
              .attr("y", 190 + margin.top)
              .attr("x", 150 )
              .attr("text-anchor","start")

      //  emplacements des texts
      svg.append("text")
              .attr("id","valeur_rang")
              .attr("y", 50 + margin.left)
              .attr("x", function(){return d3.select("#valeur_voyageurs").attr("x")})
              .style("text-anchor","start")

      // emplacement du rang pour la gare 2
      svg.append("text")
              .attr("id","valeur_rang2")
              .attr("y", 50 + margin.left)
              .attr("x",function(){return +d3.select("#valeur_voyageurs2").attr("x")})
              .style("text-anchor","end")

      // emplacement du rang de variation pour la gare 1
      svg.append("text")
              .attr("id","valeur_rangvar")
              .attr("y", 78 + margin.left)
              .attr("x", function(){return d3.select("#valeur_variation").attr("x")})
              .style("text-anchor","start")

      // emplacement du rang de varaition pour la gare 2
      svg.append("text")
              .attr("id","valeur_rangvar2")
              .attr("y", 78 + margin.left)
              .attr("x",function(){return +d3.select("#valeur_variation2").attr("x")})
              .style("text-anchor","end")

      data.forEach(function(d){
        if(d.Code_UIC == gare1){

          d3.select("#valeur_rang")
                  .text("(#"+(128-d.RangNbVoy)+")")
                  .attr("fill",couleur1)

          d3.select("#valeur_rangvar")
                  .text("(#"+(128-d.RangVariations)+")")
                  .attr("fill",couleur1)

          d3.select("#valeur_voyageurs")
                  .text(d3.format(".3s")(d.voyageurs_2016))
                  .attr("fill",couleur1)
          //.attr("class","text_colorie")

          d3.select("#valeur_variation")
                  .text(d3.format(".0%")(d.variation))
                  .attr("fill",couleur1)
          //.attr("class","text_colorie")

          d3.select("#nom1")
                  .text(d.Nom_de_la_gare)
                  .attr("fill",couleur1)
          //.attr("class","text_colorie")

          ;}
        else if(d.Code_UIC == gare2){

          d3.select("#valeur_rang2")
                  .text("(#"+(128-d.RangNbVoy)+")")
                  .attr("fill",couleur2)

          d3.select("#valeur_rangvar2")
                  .text("(#"+(128-d.RangVariations)+")")
                  .attr("fill",couleur2)

          d3.select("#valeur_voyageurs2")
                  .text(d3.format(".3s")(d.voyageurs_2016))
                  .attr("fill",couleur2)


          d3.select("#valeur_variation2")
                  .text(d3.format(".0%")(d.variation))
                  .attr("fill",couleur2)


          d3.select("#nom2")
                  .text(d.Nom_de_la_gare)
                  .attr("fill",couleur2)


          ;}
        ;})
      ;}
    function refreshWifi(div1,div2,i){

      creationRects(x_divertissements1+(i*h_rect)+(i*w_rect),y_divertissements,"valeur_wifi",function(){if(div1[i][1]=='true'){return couleur1}else{return couleur3}})

      creationRects(x_divertissements2+(i*h_rect)+(i*w_rect),y_divertissements,"valeur_wifi2",function(){if(div2[i][1]=='true'){return couleur2}else{return couleur3}})

      var svg_wifi = svg.append("svg")
      svg_wifi.attr("preserveAspectRatio","xMidYMid meet")
              .attr("viewBox","0 0 550 550")
              .attr("width",h_rect)
              .attr("height",h_rect)
      svg_wifi.append("path")
              .attr("id","path_wifi")
              .attr("d","M0,146.93c2.44-6.87,7.4-11.36,13.32-15.39C68,94.27,127.92,70,193.55,60.83c112-15.68,214.64,8.85,308,72.69A29,29,0,0,1,512,146.93v9c-3.81,9-9.67,15.3-20.35,15.28-4.91,0-9-2-12.87-4.72-41-28.73-85.82-49.46-134.72-60.22Q177,69.54,34.84,165.37c-4.16,2.81-8.22,5.57-13.52,5.8C10.17,171.67,4,165.34,0,155.93v-9Z")
      svg_wifi.append("path")
              .attr("id","path_wifi")
              .attr("d","M422.62,249.08c-4.29.19-8.32-1.53-12.11-4.18-36.07-25.25-75.92-41.14-119.59-46.63q-93.66-11.77-174.76,37.07c-5.13,3.09-10,6.52-15,9.8-10.2,6.68-22.21,4.66-28.6-4.82s-4-21.09,5.88-28C117.56,184.87,160.66,167,208,159.86c79.81-12,153.39,4.53,220.69,49.05a74.62,74.62,0,0,1,7.3,5.23,19.67,19.67,0,0,1,5.62,22.23C438.69,244.07,431.42,249,422.62,249.08Z")
      svg_wifi.append("path")
              .attr("id","path_wifi")
              .attr("d","M353.72,327a19.38,19.38,0,0,1-11.64-3.81c-29.65-20.36-62.49-28.94-98.27-26.26a145.19,145.19,0,0,0-72.55,25.41c-6.16,4.23-12.59,6.1-19.76,3.52-7.75-2.79-12.28-8.56-13.24-16.64s2.33-14.31,8.86-18.88a178.83,178.83,0,0,1,65.23-28.79c54.58-11.77,105.41-2.86,152,28.45,8.2,5.51,11.31,14.2,8.6,23A20,20,0,0,1,353.72,327Z")
      svg_wifi.append("path")
              .attr("id","path_wifi")
              .attr("d","M256.44,355.87A49.92,49.92,0,0,1,306,406.06c-0.08,27.33-22.74,49.8-50.13,49.7a50.15,50.15,0,0,1-49.77-50.55C206.23,377.84,228.79,355.75,256.44,355.87Z")

      svg_wifi.attr("transform","translate("+ d3.select("#valeur_wifi").attr("x") +","+d3.select("#valeur_wifi").attr("y")+")")


    }
  </script>
</div>
</body>
