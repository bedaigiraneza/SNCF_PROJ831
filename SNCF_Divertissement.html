<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <style>
    body { margin:0;position:fixed;top:0;right:0;bottom:0;left:0;font-family : 'Arial'; font-size: 15}
    rect { opacity:1;}
  </style>
</head>

<body>
<div>
  <script>
    // Feel free to change or delete any of the code you see in this editor!
    var margin = {top : 20,left: 0, right: 20, bottom: 20}
    
    var svg = d3.select("body").append("svg")
      .attr("width", 960)
      .attr("height", 500);

    // gare 1 selectionnée virtuellement 
    var gare1 = 713040; //384008 //713040//  
    // gare 2 selectionnée virtuellement
    var gare2 = 384008; //172007
    
    var w_rect = 18;
    var h_rect = 36;
    var x_divertissements1= 220;
    var x_divertissements2= x_divertissements1+w_rect;
    var y_divertissements = 95;
    var y_acces = 160;
    
    var couleur1 = 'green';
    var couleur2 =	'yellow';
    var couleur3 = 'lightgrey';
    
 		// définition des dimensions globalisées des carrés
    
		var histo_acces = svg.append("g");
    
    var div = d3.select("body").append("div")	
    .attr("class", "tooltip")
    .attr("width","50px")
    //.style("position","absolute")
    .style("display","inlineblock")
    .style("background-color","white")
    .style("border","1px solid grey")
    .style("border-radius","10px")
    .style("opacity", 0);
 	

// début csv
d3.csv("all-joined-datasets.csv",function(data){

  var divertissements1 = [{uic: gare1}] //json avec les divertissements en gare1
  var divertissements2 = [{uic: gare2}] //json avec les divertissements en gare2
  
  var acces1 = [{uic: gare1}] //json avec les moyens d'acces en gare1
  var acces2 = [{uic: gare2}] //json avec les moyens d'acces en gare2
  
  var motif1 = [{uic: gare1}] //json avec les motif d'arrivé en gare1
  var motif2 = [{uic: gare2}] //json avec les motif d'arrivé en gare2
  
  //parcour des données
  data.forEach(function(d){
    // text
    d.variation = (+d.voyageurs_2016-+d.voyageurs_2015)/(d.voyageurs_2015)

	if(d.Code_UIC == gare1){
		divertissements1.push({wifi: d.Wifi,
													 baby_foot: d.Baby_Foot,
													 powerstation: d.Power_Station,
													 piano: d.Piano,
													 histoires: d.Distr_Histoires_Courtes})
    
    acces1.push({voiture: +d.deux_roues_motorisees + +d.Autres_voitures_location_autopartage + +d.Voiture_Conducteur + +d.Voiture_passager,
                 taxis: +d.Taxis,
    						 bus: +d.Bus_Car_Navette,
                 metro: +d.Metro_RER,
                 tram: +d.Tramway,
    						 marche: +d.Marche,
    						 velo: +d.Velo})
    
    motif1.push({divers: +d.Demarches_administratives_medicales_ou_achat,
                 commute: +d.Deplacement_domicile_travail_habituel,
                 etudes: +d.Deplacement_domicile_etude_y_compris_stage,
    						 occasionnel: +d.Deplacement_professionnel_occasionnel,
   							 loisirs: +d.Loisirs_vacances_visite_d_un_proche_ou_ami})
  }  
	if(d.Code_UIC == gare2){
		divertissements2.push({wifi: d.Wifi,
													 baby_foot: d.Baby_Foot,
													 powerstation: d.Power_Station,
													 piano: d.Piano,
													 histoires: d.Distr_Histoires_Courtes})
    
    acces2.push({voiture: +d.deux_roues_motorisees + +d.Autres_voitures_location_autopartage + +d.Voiture_Conducteur + +d.Voiture_passager,
                 taxis: +d.Taxis,
    						 bus: +d.Bus_Car_Navette,
                 metro: +d.Metro_RER,
                 tram: +d.Tramway,
    						 marche: +d.Marche,
    						 velo: +d.Velo})
    
    motif2.push({divers: +d.Demarches_administratives_medicales_ou_achat,
                 commute: +d.Deplacement_domicile_travail_habituel,
                 etudes: +d.Deplacement_domicile_etude_y_compris_stage,
    						 occasionnel: +d.Deplacement_professionnel_occasionnel,
   							 loisirs: +d.Loisirs_vacances_visite_d_un_proche_ou_ami})
  }
	})
  if (gare1 == null && gare2 != null){
    divertissements1 = divertissements2
    acces1 = acces2
    motif1 = motif2;
  }
  else if(gare1 != null && gare2 == null){
    divertissements2 = divertissements1
    acces2 = acces1
    motif2 = motif1;
  }

  refreshText(data,gare1,gare2)
  refreshDiv(divertissements1,divertissements2)
  refreshAcces(acces1,acces2)
  d3.selectAll("rect")
          .attr("width",w_rect)
          .attr("height",h_rect)
  // utilisation des dimensions globalisées #modif


  refreshMotif(motif1,motif2)
  if(gare1==null){d3.selectAll("rect").style("fill",couleur2);}
  else if(gare2==null){d3.selectAll("rect").style("fill",couleur1);}


  ;

})
    // Définition des fonctions

    function refreshText(data,gare1,gare2){

        // emplacement du text 'nom des gares'
        svg.append("text")
            .attr("id","nom")
            .text("Nom des gares")
            .attr("y", 0 + margin.top)
            .attr("x", 0 + margin.left)
            .attr("text-anchor","start")

        // emplacement du nom de la gare 1
        svg.append("text")
            .attr("id","nom1")
            .text("")
            .attr("y", 0 + margin.top)
            .attr("x", function(){return d3.select("#nom").attr("x")+275})
            .attr("text-anchor","end")

        // emplacement du nom de la gare 2
        svg.append("text")
            .attr("id","nom2")
            .text("")
            .attr("y", 0 + margin.top)
            .attr("x", function(){return d3.select("#nom").attr("x")+350})
            .attr("text-anchor","start")


      // emplacement du text 'nombre de voyageurs'
      svg.append("text")
              .attr("id","Nombredevoyageurs")
              .text("Nombre de voyageurs")
              .attr("y", 30 + margin.top)
              .attr("x", 0 + margin.left)
              .attr("text-anchor","start")

      // emplacement de la valeur correspondante pour la gare 1
      svg.append("text")
              .attr("id","valeur_voyageurs")
              .text("")
              .attr("y", 30 + margin.top)
              .attr("x",function(){return d3.select("#Nombredevoyageurs").attr("x")+275})
              .attr("text-anchor","end")

      // emplacement de la valeur correspondante pour la gare 2
      svg.append("text")
              .attr("id","valeur_voyageurs2")
              .text("")
              .attr("y", 30 + margin.top)
              .attr("x", function(){return d3.select("#Nombredevoyageurs").attr("x")+350})
              .attr("text-anchor","start")

      // emplacement du text 'variation par rapport à 2015'
      svg.append("text")
              .attr("id","Variation")
              .text("Variation par rapport à 2015")
              .attr("y", 60 + margin.top)
              .attr("x", 0 + margin.left)
              .attr("text-anchor","start")

      // emplacement de la valeur correspondante pour la gare 1
      svg.append("text")
              .attr("id","valeur_variation")
              .text("")
              .attr("y", 78 + margin.left)
              .attr("x", function(){return d3.select("#Variation").attr("x")+275})
              .style("text-anchor","end")

      // emplacement de la valeur correspondante pour la gare 2
      svg.append("text")
              .attr("id","valeur_variation2")
              .text("")
              .attr("y", 78 + margin.left)
              .attr("x", function(){return d3.select("#Variation").attr("x")+350})
              .style("text-anchor","start")

      // emplacement du text 'Divertissement'
      svg.append("text")
              .attr("id","Wifi")
              .text("Divertissements")
              .attr("y", 100 + margin.top)
              .attr("x", 0 + margin.left)
              .attr("text-anchor","start")

      // emplacement du text "Moyens d'acces"
      svg.append("text")
              .attr("id","Moyenacces")
              .text("Moyens d'accès")
              .attr("y", 145 + margin.top)
              .attr("x", 0 + margin.left)
              .attr("text-anchor","start")

      // emplacement du text "Motif du déplacement"
      svg.append("text")
              .attr("id","Motifsdeplacements")
              .text("Motif du déplacement")
              .attr("y", 190 + margin.top)
              .attr("x", 150 )
              .attr("text-anchor","start")

      // emplacement du text 'nombre de voyageurs'
      svg.append("text")
              .attr("id","Nombredevoyageurs")
              .text("Nombre de voyageurs")
              .attr("y", 30 + margin.top)
              .attr("x", 0 + margin.left)
              .attr("text-anchor","start")

      // emplacement de la valeur correspondante pour la gare 1
      svg.append("text")
              .attr("id","valeur_voyageurs")
              .text("")
              .attr("y", 30 + margin.top)
              .attr("x",function(){return d3.select("#Nombredevoyageurs").attr("x")+275})
              .attr("text-anchor","end")

      // emplacement de la valeur correspondante pour la gare 2
      svg.append("text")
              .attr("id","valeur_voyageurs2")
              .text("")
              .attr("y", 30 + margin.top)
              .attr("x", function(){return d3.select("#Nombredevoyageurs").attr("x")+350})
              .attr("text-anchor","start")

      // emplacement du text 'variation par rapport à 2015'
      svg.append("text")
              .attr("id","Variation")
              .text("Variation par rapport à 2015")
              .attr("y", 60 + margin.top)
              .attr("x", 0 + margin.left)
              .attr("text-anchor","start")

      // emplacement de la valeur correspondante pour la gare 1
      svg.append("text")
              .attr("id","valeur_variation")
              .text("")
              .attr("y", 78 + margin.left)
              .attr("x", function(){return d3.select("#Variation").attr("x")+275})
              .style("text-anchor","end")

      // emplacement de la valeur correspondante pour la gare 2
      svg.append("text")
              .attr("id","valeur_variation2")
              .text("")
              .attr("y", 78 + margin.left)
              .attr("x", function(){return d3.select("#Variation").attr("x")+350})
              .style("text-anchor","start")

      // emplacement du text 'Divertissement'
      svg.append("text")
              .attr("id","Wifi")
              .text("Divertissements")
              .attr("y", 100 + margin.top)
              .attr("x", 0 + margin.left)
              .attr("text-anchor","start")

      // emplacement du text "Moyens d'acces"
      svg.append("text")
              .attr("id","Moyenacces")
              .text("Moyens d'accès")
              .attr("y", 145 + margin.top)
              .attr("x", 0 + margin.left)
              .attr("text-anchor","start")

      // emplacement du text "Motif du déplacement"
      svg.append("text")
              .attr("id","Motifsdeplacements")
              .text("Motif du déplacement")
              .attr("y", 190 + margin.top)
              .attr("x", 150 )
              .attr("text-anchor","start")

      //  emplacements des texts
      svg.append("text")
              .attr("id","valeur_rang")
              .attr("y", 50 + margin.left)
              .attr("x", function(){return d3.select("#valeur_voyageurs").attr("x")})
              .style("text-anchor","start")

      // emplacement du rang pour la gare 2
      svg.append("text")
              .attr("id","valeur_rang2")
              .attr("y", 50 + margin.left)
              .attr("x",function(){return +d3.select("#valeur_voyageurs2").attr("x")})
              .style("text-anchor","end")

      // emplacement du rang de variation pour la gare 1
      svg.append("text")
              .attr("id","valeur_rangvar")
              .attr("y", 78 + margin.left)
              .attr("x", function(){return d3.select("#valeur_variation").attr("x")})
              .style("text-anchor","start")

      // emplacement du rang de varaition pour la gare 2
      svg.append("text")
              .attr("id","valeur_rangvar2")
              .attr("y", 78 + margin.left)
              .attr("x",function(){return +d3.select("#valeur_variation2").attr("x")})
              .style("text-anchor","end")

      data.forEach(function(d){
        if(d.Code_UIC == gare1){

          d3.select("#valeur_rang")
                  .text("(#"+(128-d.RangNbVoy)+")")
                  .attr("fill",couleur1)

          d3.select("#valeur_rangvar")
                  .text("(#"+(128-d.RangVariations)+")")
                  .attr("fill",couleur1)

          d3.select("#valeur_voyageurs")
                  .text(d3.format(".3s")(d.voyageurs_2016))
                  .attr("fill",couleur1)
          //.attr("class","text_colorie")

          d3.select("#valeur_variation")
                  .text(d3.format(".0%")(d.variation))
                  .attr("fill",couleur1)
          //.attr("class","text_colorie")

          d3.select("#nom1")
                  .text(d.Nom_de_la_gare)
                  .attr("fill",couleur1)
          //.attr("class","text_colorie")

          ;}
        else if(d.Code_UIC == gare2){

          d3.select("#valeur_rang2")
                  .text("(#"+(128-d.RangNbVoy)+")")
                  .attr("fill",couleur2)

          d3.select("#valeur_rangvar2")
                  .text("(#"+(128-d.RangVariations)+")")
                  .attr("fill",couleur2)

          d3.select("#valeur_voyageurs2")
                  .text(d3.format(".3s")(d.voyageurs_2016))
                  .attr("fill",couleur2)


          d3.select("#valeur_variation2")
                  .text(d3.format(".0%")(d.variation))
                  .attr("fill",couleur2)


          d3.select("#nom2")
                  .text(d.Nom_de_la_gare)
                  .attr("fill",couleur2)


          ;}
        ;})
      ;}

  </script>
</div>
</body>
